source("functions/observation_split.R")
source("functions/count_instances.R")
source("functions/u_remove.R")
source("functions/bs_remove.R")
source("functions/get_sun.R")
source("functions/wesolowski_plot.R")
library(dplyr)
library(lubridate)
library(ggplot2)
library(lattice)
library(tidyr)
# Wczytywanie dancyh o słońcu
sun <- get_sun("input/wschody_zachody_2012.csv")
sun <- tbl_df(sun)
# WCZYTUJEMY OBIE TABELE
jablow <- read.csv2("input/jablow_calosc.csv", as.is = TRUE)
krajanow <- read.csv2("input/krajanow_calosc.csv", as.is = TRUE)
jablow <- tbl_df(jablow)
krajanow <- tbl_df(krajanow)
calosc <- bind_rows(krajanow, jablow)
rm(jablow)
rm(krajanow)
## DOdawanie zmiennej "kolonia"
calosc$Season <- toupper(calosc$Season)
calosc<- separate(calosc,Season, c("kolonia", "Season"), "_")
calosc$Season[calosc$Season == "1"] <- "I"
calosc$Season[calosc$Season == "2"] <- "II"
calosc$Season[calosc$Season == "3"] <- "III"
## Zmieniam daty na format R - patrz lubridate
calosc$Date_time <- dmy_hms(paste(calosc$Data, calosc$Time))
calosc$Date_time <- calosc$Date_time -  minutes(60)
# Ustalamy porę dnia (wieczór/rano)
calosc$godzina <- hour(calosc$Date_time)
calosc$Part_night <- factor(ifelse(calosc$godzina>=12, "wieczor", "rano"))
calosc$Part_night <- relevel(calosc$Part_night, "wieczor")
# Czyścimy tabelę ze zbędnych kolumn
calosc <- select(calosc, kolonia, Season, Phase, Date_time,Channel, Night, Part_night,
Event_V, Toys, Quantity)
# Dodajemy dane o słońcu
calosc$date <- as.Date(calosc$Date_time)
calosc <- left_join(calosc, sun, by ="date" )
calosc <- mutate(calosc,after_dusk = Date_time - sunset,
till_dawn = sunrise - Date_time)
#histogram(as.numeric(calosc$after_dusk[calosc$Part_night=="wieczor"])/60)
#histogram(as.numeric(calosc$till_dawn[calosc$Part_night=="rano"]))
#hist_act <- ggplot(calosc[calosc$Part_night == "wieczor",], aes(x = as.numeric(after_dusk)/60))
#hist_act + geom_histogram(binwidth = 5) + facet_grid(. ~ Season)
#hist_act <- ggplot(calosc[calosc$Part_night == "rano",], aes(x = as.numeric(till_dawn)))
#hist_act + geom_histogram(binwidth = 5) + facet_grid(. ~ Season) +
#scale_x_continuous(limits = c(0, 150))
## Usuwamy dane zawierające oberwacje niepełne (u) oraz
# obserwacje duże i male (b i s), bez podmianki wewnętrzych
# elementów na "/", kontroluje to parametr slash
calosc <- u_remove(calosc, slash = F)
calosc <- bs_remove(calosc, slash = F)
calosc <- filter(calosc, Event_V != "")
## Liczymy zdarzenia w obrębie każdego kodu
characters <-c("a","v","c","l","t","o","d","f","w","n","e", "h", "g","r",
"i", "k","q","p")
zdarzenia <- count_instances(calosc, characters)
calosc_zdarzenia <- cbind(calosc, zdarzenia)
# Zamieniamy dane o pogoni na zmienną logiczną
p <- zdarzenia$p
p[is.na(p)] <-0
calosc_zdarzenia$czy_pogon <- as.logical(p)
# ZLiczamy ilość elementów w sekwencji
calosc_zdarzenia$ilosc_elementow <- apply(calosc_zdarzenia[,16:29],1,sum, na.rm = T)
calosc_zdarzenia <- mutate(calosc_zdarzenia,
srednia_ilosc_elementow  = ilosc_elementow/Quantity)
# Sprawdzamy czy obserwacje z pogoniami są bardziej
# złożone od obserwacji 2 niezależnych osobników
#sub <- filter(calosc_zdarzenia, Quantity>1)
#sub_plot <- ggplot(calosc_zdarzenia, aes(y = srednia_ilosc_elementow, x = czy_pogon))
#sub_plot + geom_boxplot() + facet_grid(.~Season)
### TNIEMY TABELĘ - JEDEN NIETOPERZ NA JEDNĄ OBSERWACJĘ
calosc_split <- observation_split(calosc)
# LIczymy poszczególne zdarzenia
characters <-c("a","v","c","l","t","o","d","f","w","n","e", "h", "g","r",
"i", "k","q","p")
zdarzenia <- count_instances(calosc_split, characters)
calosc_split_zdarzenia <- cbind(calosc_split, zdarzenia)
calosc_split_zdarzenia$ilosc_elementow <- apply(calosc_split_zdarzenia[,16:29],1,sum, na.rm = T)
calosc_split_zdarzenia$shannon <- apply(as.matrix(zdarzenia), 1, function(x){
suma <- sum(x, na.rm = T)
prawd <- x/suma
s <- -1 * sum(log(prawd^prawd), na.rm = T)
s
})
shan_plot <- ggplot(calosc_split_zdarzenia, aes(x = Part_night, y = shannon))
shan_plot + geom_boxplot(aes(x = Channel)) + facet_grid(kolonia~Season)
# Grupujemy po sezonach, nocach i porze dnia, żeby potem policzyć sumy dla konkretnych
# zdarzeń
calosc_split_zdarzenia <- group_by(calosc_split_zdarzenia, kolonia, Season, Night, Part_night)
### Liczymy liczbę pościgów i liczbę zdarzeń
summary_calosc <- summarise_each(calosc_split_zdarzenia,
funs(
sum(., na.rm = T)
), vars = -c(1:15))
# Liczymy średnią liczbę pościgów
# Ilość obserwacji
summary_calosc$n_observation <- summarise(calosc_split_zdarzenia, n_observ = n())$n_observ
# Dodajemy średnie ilości pościgów
summary_calosc <- mutate(summary_calosc, mean_p = p/n_observation)
# Średnie złożoności, czyli średnia ilość elementów w pojedynczej obserwacji
summary_calosc$srednia_sekwencja <- summarise(calosc_split_zdarzenia,
srednia_sekwencja = mean(ilosc_elementow))$srednia_sekwencja
pogon_gg <- ggplot(summary_calosc, aes(y = mean_p, x = Part_night))
pogon_gg + geom_boxplot() + facet_grid(kolonia~Season) + theme_wesolowski()
setwd("~/R/gacki_analiza")
source("functions/observation_split.R")
source("functions/count_instances.R")
source("functions/u_remove.R")
source("functions/bs_remove.R")
source("functions/get_sun.R")
source("functions/wesolowski_plot.R")
library(dplyr)
library(lubridate)
library(ggplot2)
library(lattice)
library(tidyr)
# Wczytywanie dancyh o słońcu
sun <- get_sun("input/wschody_zachody_2012.csv")
sun <- tbl_df(sun)
# WCZYTUJEMY OBIE TABELE
jablow <- read.csv2("input/jablow_calosc.csv", as.is = TRUE)
krajanow <- read.csv2("input/krajanow_calosc.csv", as.is = TRUE)
jablow <- tbl_df(jablow)
krajanow <- tbl_df(krajanow)
calosc <- bind_rows(krajanow, jablow)
rm(jablow)
rm(krajanow)
## DOdawanie zmiennej "kolonia"
calosc$Season <- toupper(calosc$Season)
calosc<- separate(calosc,Season, c("kolonia", "Season"), "_")
calosc$Season[calosc$Season == "1"] <- "I"
calosc$Season[calosc$Season == "2"] <- "II"
calosc$Season[calosc$Season == "3"] <- "III"
## Zmieniam daty na format R - patrz lubridate
calosc$Date_time <- dmy_hms(paste(calosc$Data, calosc$Time))
calosc$Date_time <- calosc$Date_time -  minutes(60)
# Ustalamy porę dnia (wieczór/rano)
calosc$godzina <- hour(calosc$Date_time)
calosc$Part_night <- factor(ifelse(calosc$godzina>=12, "wieczor", "rano"))
calosc$Part_night <- relevel(calosc$Part_night, "wieczor")
# Czyścimy tabelę ze zbędnych kolumn
calosc <- select(calosc, kolonia, Season, Phase, Date_time,Channel, Night, Part_night,
Event_V, Toys, Quantity)
# Dodajemy dane o słońcu
calosc$date <- as.Date(calosc$Date_time)
calosc <- left_join(calosc, sun, by ="date" )
calosc <- mutate(calosc,after_dusk = Date_time - sunset,
till_dawn = sunrise - Date_time)
#histogram(as.numeric(calosc$after_dusk[calosc$Part_night=="wieczor"])/60)
#histogram(as.numeric(calosc$till_dawn[calosc$Part_night=="rano"]))
#hist_act <- ggplot(calosc[calosc$Part_night == "wieczor",], aes(x = as.numeric(after_dusk)/60))
#hist_act + geom_histogram(binwidth = 5) + facet_grid(. ~ Season)
#hist_act <- ggplot(calosc[calosc$Part_night == "rano",], aes(x = as.numeric(till_dawn)))
#hist_act + geom_histogram(binwidth = 5) + facet_grid(. ~ Season) +
#scale_x_continuous(limits = c(0, 150))
## Usuwamy dane zawierające oberwacje niepełne (u) oraz
# obserwacje duże i male (b i s), bez podmianki wewnętrzych
# elementów na "/", kontroluje to parametr slash
calosc <- u_remove(calosc, slash = F)
calosc <- bs_remove(calosc, slash = F)
calosc <- filter(calosc, Event_V != "")
## Liczymy zdarzenia w obrębie każdego kodu
characters <-c("a","v","c","l","t","o","d","f","w","n","e", "h", "g","r",
"i", "k","q","p")
zdarzenia <- count_instances(calosc, characters)
calosc_zdarzenia <- cbind(calosc, zdarzenia)
# Zamieniamy dane o pogoni na zmienną logiczną
p <- zdarzenia$p
p[is.na(p)] <-0
calosc_zdarzenia$czy_pogon <- as.logical(p)
# ZLiczamy ilość elementów w sekwencji
calosc_zdarzenia$ilosc_elementow <- apply(calosc_zdarzenia[,16:29],1,sum, na.rm = T)
calosc_zdarzenia <- mutate(calosc_zdarzenia,
srednia_ilosc_elementow  = ilosc_elementow/Quantity)
# Sprawdzamy czy obserwacje z pogoniami są bardziej
# złożone od obserwacji 2 niezależnych osobników
#sub <- filter(calosc_zdarzenia, Quantity>1)
#sub_plot <- ggplot(calosc_zdarzenia, aes(y = srednia_ilosc_elementow, x = czy_pogon))
#sub_plot + geom_boxplot() + facet_grid(.~Season)
### TNIEMY TABELĘ - JEDEN NIETOPERZ NA JEDNĄ OBSERWACJĘ
calosc_split <- observation_split(calosc)
# LIczymy poszczególne zdarzenia
characters <-c("a","v","c","l","t","o","d","f","w","n","e", "h", "g","r",
"i", "k","q","p")
zdarzenia <- count_instances(calosc_split, characters)
calosc_split_zdarzenia <- cbind(calosc_split, zdarzenia)
calosc_split_zdarzenia$ilosc_elementow <- apply(calosc_split_zdarzenia[,16:29],1,sum, na.rm = T)
calosc_split_zdarzenia$shannon <- apply(as.matrix(zdarzenia), 1, function(x){
suma <- sum(x, na.rm = T)
prawd <- x/suma
s <- -1 * sum(log(prawd^prawd), na.rm = T)
s
})
shan_plot <- ggplot(calosc_split_zdarzenia, aes(x = Part_night, y = shannon))
shan_plot + geom_boxplot(aes(x = Channel)) + facet_grid(kolonia~Season)
# Grupujemy po sezonach, nocach i porze dnia, żeby potem policzyć sumy dla konkretnych
# zdarzeń
calosc_split_zdarzenia <- group_by(calosc_split_zdarzenia, kolonia, Season, Night, Part_night)
### Liczymy liczbę pościgów i liczbę zdarzeń
summary_calosc <- summarise_each(calosc_split_zdarzenia,
funs(
sum(., na.rm = T)
), vars = -c(1:15))
# Liczymy średnią liczbę pościgów
# Ilość obserwacji
summary_calosc$n_observation <- summarise(calosc_split_zdarzenia, n_observ = n())$n_observ
# Dodajemy średnie ilości pościgów
summary_calosc <- mutate(summary_calosc, mean_p = p/n_observation)
# Średnie złożoności, czyli średnia ilość elementów w pojedynczej obserwacji
summary_calosc$srednia_sekwencja <- summarise(calosc_split_zdarzenia,
srednia_sekwencja = mean(ilosc_elementow))$srednia_sekwencja
pogon_gg <- ggplot(summary_calosc, aes(y = mean_p, x = Part_night))
pogon_gg + geom_boxplot() + facet_grid(kolonia~Season) + theme_wesolowski()
View(summary_calosc)
summary_calosc$sredni_shannon <- summarise(calosc_split_zdarzenia,
sredni_shannon = mean(shannon))$sredni_shannon
pogon_gg <- ggplot(summary_calosc, aes(y = mean_p, x = Part_night))
pogon_gg + geom_boxplot() + facet_grid(kolonia~Season) + theme_wesolowski()
pogon_gg <- ggplot(summary_calosc, aes(y = sredni_shannon, x = Part_night))
pogon_gg + geom_boxplot() + facet_grid(kolonia~Season) + theme_wesolowski()
pogon_gg <- ggplot(summary_calosc, aes(y = n_observation, x = Part_night))
pogon_gg + geom_boxplot() + facet_grid(kolonia~Season) + theme_wesolowski()
View(summary_calosc)
sum(summary_calosc$n_observation)
pogon_gg <- ggplot(summary_calosc, aes(y = mean_p, x = Part_night))
pogon_gg + geom_boxplot() + facet_grid(kolonia~Season) + theme_wesolowski()
grupy <- ggplot(calosc_zdarzenia, aes(x = Quantity))
grupy + geom_bar()
grupy + geom_bar() + facet_grid(kolonia~Season)
grupy <- ggplot(calosc_zdarzenia, aes(x = as.factor(Quantity)))
grupy + geom_bar() + facet_grid(kolonia~Season)
grupy <- ggplot(calosc_zdarzenia,
aes(x = as.factor(Quantity),
fill=czy_pogon ))
grupy + geom_bar() + facet_grid(kolonia~Season)
sub <- filter(calosc_zdarzenia, Quantity >1)
grupy <- ggplot(sub,
aes(x = as.factor(Quantity),
fill=czy_pogon ))
grupy + geom_bar() + facet_grid(kolonia~Season)
grupy + geom_bar() + facet_grid(.~Season)
